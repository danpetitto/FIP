from flask import Blueprint, render_template, request, redirect, url_for, flash, session
from flask_login import login_required, current_user
from models import Portfolio, db
from finance import (
    calculate_portfolio_value, calculate_realized_profit, 
    calculate_unrealized_profit, calculate_invested_amount, 
    calculate_dividend_cash, calculate_fees
)
import pandas as pd
from io import BytesIO
from datetime import datetime
from portfolio_analysis import get_delayed_price_polygon, get_sector_from_ticker
from investment_history import calculate_investment_history  # Ujisti se, že tato funkce existuje

def get_ticker_from_isin(isin):
    # Zde by mělo dojít k mapování ISIN na ticker
    isin_mapping = {
        'US0378331005': 'AAPL',  # Apple
        'US88160R1014': 'TSLA',  # Tesla
        'US02079K3059': 'GOOGL',  # Google
    }
    return isin_mapping.get(isin, None)


portfolio_bp = Blueprint('portfolio', __name__)

# Funkce pro výpočet výsledků portfolia, očekává ISIN pro každou akcii
def calculate_portfolio_results(data):
    tickers_prices = {
        'ticker': {},
        'current_price': {},
        'sector': {}
    }

    stock_info_list = []

    # Získání tickerů, cen a odvětví pro každou jedinečnou ISIN
    unique_isins = data['ISIN'].unique()
    for isin in unique_isins:
        ticker = get_ticker_from_isin(isin)
        current_price = get_delayed_price_polygon(ticker)
        sector = get_sector_from_ticker(ticker)

        tickers_prices['ticker'][isin] = ticker
        tickers_prices['current_price'][isin] = current_price
        tickers_prices['sector'][isin] = sector

        # Výpočet kupní hodnoty, aktuální hodnoty a profitu pro každou akcii
        total_shares = data.loc[data['ISIN'] == isin, 'Počet'].sum()
        purchase_price = data.loc[data['ISIN'] == isin, 'Cena'].mean()
        purchase_value = total_shares * purchase_price
        current_value = total_shares * current_price if current_price else 0
        profit = current_value - purchase_value

        if ticker and current_value > 0:
            stock_info_list.append({
                'ticker': ticker,
                'kupni_hodnota': round(purchase_value, 2),
                'aktualni_hodnota': round(current_value, 2),
                'profit': round(profit, 2)
            })

    portfolio_value = calculate_portfolio_value(data)
    invested_amount = calculate_invested_amount(data)
    investment_duration = calculate_investment_duration(data)

    if investment_duration > 0:
        avg_monthly_investment = invested_amount / investment_duration
    else:
        avg_monthly_investment = 0

    # Převod investic podle jednotlivých pozic na procenta pro graf jednotlivých akcií
    total_invested_positions = sum([info['kupni_hodnota'] for info in stock_info_list])
    if total_invested_positions > 0:
        position_percentages = [(info['kupni_hodnota'] / total_invested_positions) * 100 for info in stock_info_list]
        position_labels = [info['ticker'] for info in stock_info_list]  # Přidáme tickery pro graf
    else:
        position_percentages = []
        position_labels = []

    return tickers_prices, portfolio_value, invested_amount, investment_duration, avg_monthly_investment, stock_info_list, position_percentages, position_labels

# Funkce pro výpočet doby investování (v měsících) na základě prvního záznamu investice
def calculate_investment_duration(data):
    data['Datum'] = pd.to_datetime(data['Datum'], dayfirst=True, errors='coerce')

    if data['Datum'].isnull().any():
        raise ValueError("Některá data ve sloupci 'Datum' nejsou validní.")

    oldest_date = data['Datum'].min()
    current_date = datetime.now()

    duration_in_months = (current_date.year - oldest_date.year) * 12 + current_date.month - oldest_date.month
    if current_date.day >= oldest_date.day:
        duration_in_months += 1

    return duration_in_months

# Route pro nahrávání nového portfolia
@portfolio_bp.route('/upload', methods=['GET', 'POST'])
@login_required
def upload():
    if request.method == 'POST':
        file = request.files.get('file')
        portfolio_name = request.form.get('portfolio_name')

        if not file or not portfolio_name:
            flash('Musíte nahrát soubor a zadat název portfolia.', 'error')
            return redirect(url_for('portfolio.upload'))

        if not file.filename.endswith('.csv'):
            flash('Prosím, nahrajte soubor ve formátu CSV.', 'error')
            return redirect(url_for('portfolio.upload'))

        new_portfolio = Portfolio(
            name=portfolio_name,
            filename=file.filename,
            data=file.read(),
            user=current_user
        )
        db.session.add(new_portfolio)
        db.session.commit()

        flash('Portfolio bylo úspěšně nahráno.', 'success')
        return redirect(url_for('portfolio.upload'))

    user_portfolios = Portfolio.query.filter_by(user_id=current_user.id).all()
    return render_template('upload.html', portfolios=user_portfolios)

# Route pro přidání nové transakce

@app.route('/add_transaction/<int:portfolio_id>', methods=['POST'])
@login_required
def add_transaction(portfolio_id):
    # Získání vstupů z formuláře
    ticker = request.form.get('ticker')
    transaction_type = request.form.get('transaction_type')  # Nákup nebo prodej
    shares = request.form.get('shares')
    price = request.form.get('price')
    date = request.form.get('date')
    fees = request.form.get('fees')
    currency = request.form.get('currency')

    # Debugging - vypiš přijaté údaje z formuláře
    print(f"Ticker: {ticker}, Typ transakce: {transaction_type}, Počet akcií: {shares}, Cena: {price}, Datum: {date}, Poplatky: {fees}, Měna: {currency}")

    # Validace vstupů
    if not ticker or not shares or not date:
        flash('Musíte zadat Ticker, Počet akcií a Datum.', 'error')
        return redirect(url_for('portfolio.select_portfolio', portfolio_id=portfolio_id))

    try:
        shares = int(shares)
        price = float(price)
        fees = float(fees)
    except ValueError:
        flash('Počet akcií, cena a poplatky musí být čísla.', 'error')
        return redirect(url_for('portfolio.select_portfolio', portfolio_id=portfolio_id))

    # Uložení transakce do session
    manual_transactions = session.get('manual_transactions', [])
    manual_transactions.append({
        'ticker': ticker,
        'transaction_type': transaction_type,
        'shares': shares,
        'price': price,
        'date': date,
        'fees': fees,
        'currency': currency
    })
    session['manual_transactions'] = manual_transactions

    # Debugging - výpis obsahu session po přidání transakce
    print(f"Aktuální obsah session: {session['manual_transactions']}")

    flash(f'Transakce {shares} akcií {ticker} byla úspěšně přidána.', 'success')
    return redirect(url_for('portfolio.select_portfolio', portfolio_id=portfolio_id))


# Route pro výpočet a zobrazení portfolia

@app.route('/select_portfolio/<int:portfolio_id>', methods=['GET'])
@login_required
def select_portfolio(portfolio_id):
    # Načtení dat z portfolia a session
    portfolio = Portfolio.query.get_or_404(portfolio_id)
    if portfolio.user != current_user:
        flash('Nemáte oprávnění k zobrazení tohoto portfolia.', 'error')
        return redirect(url_for('portfolio.upload'))

    # Načítání manuálních transakcí ze session
    manual_transactions = session.get('manual_transactions', [])

    # Výpočet hodnoty portfolia s manuálními transakcemi
    total_portfolio_value = calculate_portfolio_value(manual_transactions)
    
    return render_template('portfolio_detail.html', total_portfolio_value=total_portfolio_value, portfolio=portfolio)


def calculate_portfolio_value(manual_transactions):
    # Výpočet hodnoty na základě manuálních transakcí
    total_value = 0
    for transaction in manual_transactions:
        ticker = transaction['ticker']
        shares = transaction['shares']
        price = transaction['price']
        transaction_value = shares * price
        total_value += transaction_value
        print(f"Zpracovávám transakci: {ticker}, Akcie: {shares}, Cena: {price}, Celková hodnota: {transaction_value} €")
    
    print(f"Celková hodnota portfolia po přidání manuálních transakcí: {total_value} €")
    return total_value

# Route pro výpočet a zobrazení portfolia
@portfolio_bp.route('/select_portfolio/<int:portfolio_id>', methods=['GET'])
@login_required
def select_portfolio(portfolio_id):
    portfolio = Portfolio.query.get_or_404(portfolio_id)
    if portfolio.user != current_user:
        flash('Nemáte oprávnění k zobrazení tohoto portfolia.', 'error')
        return redirect(url_for('portfolio.upload'))

    # Načítání manuálních transakcí ze session
    manual_transactions = session.get('manual_transactions', [])

    # Výpočet hodnoty portfolia s manuálními transakcemi
    total_portfolio_value = calculate_portfolio_value(manual_transactions)

    return render_template('portfolio_detail.html', total_portfolio_value=total_portfolio_value, portfolio=portfolio)


def calculate_portfolio_value(manual_transactions):
    # Výpočet hodnoty na základě manuálních transakcí
    total_value = 0
    for transaction in manual_transactions:
        ticker = transaction['ticker']
        shares = transaction['shares']
        price = transaction['price']
        transaction_value = shares * price
        total_value += transaction_value
        print(f"Zpracovávám transakci: {ticker}, Akcie: {shares}, Cena: {price}, Celková hodnota: {transaction_value} €")
    
    print(f"Celková hodnota portfolia po přidání manuálních transakcí: {total_value} €")
    return total_value

# Route pro zobrazení portfolia
@portfolio_bp.route('/select_portfolio/<int:portfolio_id>', methods=['GET'])
@login_required
def select_portfolio(portfolio_id):
    portfolio = Portfolio.query.get_or_404(portfolio_id)

    if portfolio.user != current_user:
        flash('Nemáte oprávnění k zobrazení tohoto portfolia.', 'error')
        return redirect(url_for('portfolio.upload'))

    # Načtení CSV dat z portfolia
    csv_data = BytesIO(portfolio.data)
    try:
        data = pd.read_csv(csv_data, encoding='utf-8')
    except pd.errors.EmptyDataError:
        flash('Soubor je prázdný nebo neplatný.', 'error')
        return redirect(url_for('portfolio.upload'))

    # Získání manuálních transakcí ze session
    manual_transactions = session.get('manual_transactions', [])

    # Výpočet hodnoty portfolia včetně manuálních transakcí
    total_portfolio_value = calculate_portfolio_value(data, manual_transactions)

    # Výpočet dalších údajů
    tickers_prices, portfolio_value, invested_amount, investment_duration, avg_monthly_investment, stock_info_list, position_percentages, position_labels = calculate_portfolio_results(data)

    results = {
        'portfolio_value': f"{round(portfolio_value, 2)} €",
        'realized_profit': f"{round(calculate_realized_profit(data), 2)} €",
        'unrealized_profit': f"{round(calculate_unrealized_profit(portfolio_value, invested_amount), 2)} €",
        'total_dividends': f"{round(calculate_dividend_cash(data)['total_dividends'], 2)} €",
        'total_fees': f"{round(calculate_fees(data), 2)} €",
        'invested': f"{round(invested_amount, 2)} €"
    }

    # Uložení dat do session
    session['invested_amount'] = invested_amount
    session['investment_duration'] = investment_duration

    return render_template('process.html',
                           results=results,
                           total_portfolio_value=total_portfolio_value,
                           position_labels=position_labels,
                           position_percentages=position_percentages,
                           stock_info_list=stock_info_list,
                           investment_duration=investment_duration,
                           avg_monthly_investment=round(avg_monthly_investment, 2),
                           portfolio=portfolio)

# Route pro zobrazení detailů investic
@portfolio_bp.route('/investment_details', methods=['GET'])
@login_required
def investment_details():
    # Získání investované částky a doby investování ze session nebo vypočítané hodnoty
    invested_amount = session.get('invested_amount', 1519.96)  # Příkladová hodnota
    investment_duration = session.get('investment_duration', 19)  # Příkladová hodnota

    if investment_duration > 0:
        avg_monthly_investment = invested_amount / investment_duration
    else:
        avg_monthly_investment = 0

    # Získáme portfolia a jejich data
    portfolio = Portfolio.query.filter_by(user_id=current_user.id).first()
    csv_data = BytesIO(portfolio.data)
    data = pd.read_csv(csv_data, encoding='utf-8')

    # Použijeme funkci pro výpočet historie investic
    investment_history, yearly_totals = calculate_investment_history(data)

    return render_template('investment_details.html', 
                           invested_amount=round(invested_amount, 2),
                           investment_duration=investment_duration,
                           avg_monthly_investment=round(avg_monthly_investment, 2),
                           investment_history=investment_history,
                           yearly_totals=yearly_totals)

# Route pro smazání portfolia
@portfolio_bp.route('/delete_portfolio/<int:portfolio_id>', methods=['POST'])
@login_required
def delete_portfolio(portfolio_id):
    portfolio_to_delete = Portfolio.query.get_or_404(portfolio_id)

    if portfolio_to_delete.user != current_user:
        flash('Nemáte oprávnění smazat toto portfolio.', 'error')
        return redirect(url_for('portfolio.upload'))

    db.session.delete(portfolio_to_delete)
    db.session.commit()
    flash('Portfolio bylo úspěšně smazáno.', 'success')
    return redirect(url_for('portfolio.upload'))


